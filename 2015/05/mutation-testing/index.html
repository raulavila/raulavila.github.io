<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <link href="http://gmpg.org/xfn/11" rel="profile">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Mutation testing&#58; tests de máxima calidad
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/atom+xml" title="Raúl Ávila" href="/atom.xml">

</head>


  <body>

    <div class="container content">
      <header class="masthead">
        <h1 class="masthead-title">
          <a href="/" title="Home">Raúl Ávila</a>
        </h1>

            <small><a href="/sobre-mi">Sobre mí</a></small>
            &nbsp;&nbsp;&nbsp;
            <small><a href="/archivos">Archivos</a></small>
      </header>

      <main>
        <article class="post">
  <h1 class="post-title">Mutation testing&#58; tests de máxima calidad</h1>
  <time datetime="2015-05-10T00:00:00+01:00" class="post-date">10/05/2015</time>
  <div class="post-tags">
    
    | <a href="/tag/desarrollo">desarrollo</a> |
    
    | <a href="/tag/testing">testing</a> |
    
  </div>
  <div class="post-share">
    <a class="twitter-share-button"
    data-via="_Raul_Avila"
    data-count="none"
    href="https://twitter.com/share">Tweet</a>
  </div>
  <p><a href="http://en.wikipedia.org/wiki/Mutation_testing">Mutation testing</a> es una forma de evaluar la calidad de nuestros tests, que aunque según el artículo enlazado comenzó a plantearse en la década de los 70, no ha sido hasta hace relativamente poco tiempo que está adquiriendo relativa presencia en entornos empresariales. De hecho, diría que aún le falta mucho camino por recorrer para implantarse definitivamente. Espero, desde este modesto blog, aportar mi granito de arena para que su uso vaya aumentando como realmente merece.</p>

<!--break-->

<h3 id="midiendo-la-calidad-de-los-tests">Midiendo la calidad de los tests</h3>

<p>La medida más extendida para medir la calidad de una suite de tests desarrollada para un sistema en concreto, es la <a href="http://es.wikipedia.org/wiki/Cobertura_de_c%C3%B3digo">cobertura de código</a>. Las herramientas utilizadas para generar esta medida analizan las líneas del código de producción que son ejecutadas por los tests. A más líneas ejecutadas, mayor cobertura de código.</p>

<p>En la siguiente captura de pantalla podemos ver el resultado de ejecutar los tests con análisis de cobertura en IntelliJ IDEA para el <a href="https://github.com/raulavila/blog-examples">proyecto de GitHub donde subo ejemplos de este blog</a>:</p>

<p><img src="/public/pictures/pitest/cobertura.jpg" alt="Cobertura" /></p>

<p>El resultado es bastante pobre, y sería intolerable para un proyecto real (en este caso me vale la excusa de que no es más que un proyecto de ejemplos :) ). En la parte izquierda se pueden ver los porcentajes de clases y líneas cubiertas por tests, y en la derecha he abierto una clase en concreto. Veréis que en el margen izquierdo se resaltan en verde o rojo las líneas de código según estén cubiertas o no.</p>

<p>Como norma general, en cualquier proyecto serio deberíamos perseguir el objetivo de lograr el 100% de cobertura. Aunque esto es algo extremadamente complicado, ya que determinados fragmentos de código son difíciles de cubrir por tests de forma no artificial. Uno de los ejemplos más claros son los constructores de las clases <code class="highlighter-rouge">Exception</code>, por ejemplo. Me atrevería a afirmar como deseable una cobertura de 90-95%.</p>

<p>Sin embargo, no siempre tener una gran cobertura de tests garantiza que los tests sean de calidad. Lo mejor es verlo con un ejemplo (utilizando un poco de reducción al absurdo):</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MaxCoverage</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="n">addOne</span><span class="o">(</span><span class="kt">int</span> <span class="n">number</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="mi">3</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>El método <code class="highlighter-rouge">addOne</code> debería devolver el resultado de sumar uno a su parámetro, pero devuelve 3 de forma constante. El siguiente test:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MaxCoverageTest</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">MaxCoverage</span> <span class="n">maxCoverage</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MaxCoverage</span><span class="o">();</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="n">testAddOne</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">maxCoverage</span><span class="o">.</span><span class="na">addOne</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">result</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>genera una cobertura del 100% en la clase MaxCoverage…¿diriáis que el test tiene una mínima calidad por ello? Por supuesto que no. De hecho a nada que añadiéramos más casos de test romperiamos la suite y deberíamos modificar la implementación del método <code class="highlighter-rouge">addOne</code> (en realidad esta sería la forma de desarrollar utiliando TDD, de la que hablaremos en el futuro).</p>

<h3 id="mutation-testing-al-rescate">Mutation testing al rescate</h3>

<p>¿En qué consiste Mutation testing? El concepto es bastante sencillo: consiste en realizar pequeñas modificaciones en el código de producción, conocidas como “mutaciones”. Cada mutación “debería” romper algún test. Si no lo hace, la mutación “ha sobrevivido” (survived). Si rompe algún test, la mutación “ha sido derribada” (killed). De esta forma estamos generando una nueva medida de calidad, mucho más fiable que la cobertura de código, conocida como “porcentaje de mutaciones derribadas” (percentage of mutations killed). Este porcentaje debería ser del 100%.</p>

<p>Las mutaciones realizadas en el código son pequeñas modificaciones del estilo:</p>

<ul>
  <li>Cambiar el sentido de una condición ( <code class="highlighter-rouge">if(a&lt;0)</code> =&gt; <code class="highlighter-rouge">if(a&gt;=0)</code>)</li>
  <li>Eliminar llamadas a métodos void</li>
  <li>Eliminar llamadas a métodos con retorno, y utilizar un valor por defecto en su lugar (0 para int, etc)</li>
  <li>Operaciones matemáticas: se mutan operaciones matemáticas reemplazando el operador +  por -, etc</li>
</ul>

<p>En <a href="http://pitest.org/quickstart/mutators/">este link</a> hay una lista completa de los mutadores utilizados por la herramienta que vamos a utilizar para mostrar un ejemplo práctico de desarrollo utilizando Mutation Testing: <a href="http://pitest.org/">PIT</a>.</p>

<h3 id="mutation-testing-en-la-prctica">Mutation testing en la práctica</h3>

<p>Configuremos nuestro proyecto para generar reportes de Mutation Testing con PIT. Optaremos por utilizarlo a través de su plugin de maven, para lo cual tenemos que añadir el siguiente fragmento de código al fichero POM:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;plugin&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.pitest<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>pitest-maven<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>1.1.5<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;configuration&gt;</span>
        <span class="nt">&lt;targetClasses&gt;</span>
            <span class="nt">&lt;param&gt;</span>com.raulavila.mutationtesting*<span class="nt">&lt;/param&gt;</span>
        <span class="nt">&lt;/targetClasses&gt;</span>
        <span class="nt">&lt;targetTests&gt;</span>
            <span class="nt">&lt;param&gt;</span>com.raulavila.mutationtesting*<span class="nt">&lt;/param&gt;</span>
        <span class="nt">&lt;/targetTests&gt;</span>
    <span class="nt">&lt;/configuration&gt;</span>
<span class="nt">&lt;/plugin&gt;</span></code></pre></figure>

<p><code class="highlighter-rouge">targetClasses</code> indica las classes que serán mutadas (lo que muta realmente es su bytecode), y <code class="highlighter-rouge">targetTests</code> indica los tests que componen la suite y deben poner a prueba el código mutado. El plugin ofrece muchísimos parámetros de configuración, pero por simplicidad analizaremos un solo package utilizando los parámetros por defecto (<a href="http://en.wikipedia.org/wiki/Convention_over_configuration">convention over configuration</a>).</p>

<p>Para generar los informes hay que lanzar el siguiente goal de maven: <code class="highlighter-rouge">mvn clean verify org.pitest:pitest-maven:mutationCoverage</code>, y los podremos encontrar dentro de la carpeta target/pit-reports (aunque en la salida por consola de maven también aparecerá un resumen).</p>

<p>En nuestro ejemplo crearemos e iremos evolucionando una calculadora. La primera versión es algo tan simple como:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Calculator</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kt">long</span> <span class="n">add</span><span class="o">(</span><span class="kt">int</span> <span class="n">operand1</span><span class="o">,</span> <span class="kt">int</span> <span class="n">operand2</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">operand1</span> <span class="o">+</span> <span class="n">operand2</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<h4 id="test-defectuoso-falta-de-assertions">Test defectuoso: falta de Assertions</h4>

<p>Vamos a ir creando tests que en todo momento generarán una cobertura del 100%, pero que son claramente fallidos. PIT nos ayudará a detectar sus carencias y mejorarlos paulatinamente.</p>

<p>La primera clase de test es:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CalculatorTest</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">Calculator</span> <span class="n">calculator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Calculator</span><span class="o">();</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="n">testAdd</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">operand1</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">operand2</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>

        <span class="kt">long</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">calculator</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">operand1</span><span class="o">,</span> <span class="n">operand2</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>El fallo aquí es claro (además de que lo he mencionado en el título :) ): faltan assertions. Aunque aquí es bastante evidente, en sistemas grandes puede que se nos escape verificar algún valor dentro de un mar de assertions, cosa que PIT destapará sin problemas, como podemos ver en el informe:</p>

<p><img src="/public/pictures/pitest/pitest1.jpg" alt="Informe pitest" /></p>

<p>En esta vista general destaca cómo esta herramienta también realiza informes de cobertura. De hecho, si una mutación deja código sin cobertura nos lo hará saber. También podemos ver como todas las mutaciones han sobrevivido, cosa totalmente normal, puesto que no hay ningún assertion que compruebe el resultado de la llamada al método <code class="highlighter-rouge">add</code>. En el informe detallado de la clase vemos qué mutaciones se han puesto a prueba:</p>

<p><img src="/public/pictures/pitest/pitest2.jpg" alt="Informe pitest" /></p>

<p>Una de ellas ha modificdo el operador (+ por -), y la otra ha incrementado en 1 el retorno de la función.</p>

<p>Vamos a arrelgar nuestra clase de test:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testAdd</span><span class="p">(</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">operand1</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">operand2</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>

    <span class="kt">long</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">calculator</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">operand1</span><span class="o">,</span> <span class="n">operand2</span><span class="o">);</span>

    <span class="n">assertThat</span><span class="o">(</span><span class="n">sum</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">4</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<p>Ahora sí hemos conseguido hacer feliz a PIT:</p>

<p><img src="/public/pictures/pitest/pitest3.jpg" alt="Informe pitest" /></p>

<p>La verdad es que este test no es perfecto. Desde mi punto de vista, cuando testeamos clases que trabajan con operandos, el enfoque de <a href="http://es.wikipedia.org/wiki/Data-driven_testing">Data Driven Testing</a> es mucho más adecuado. Por ello lo utilizaremos en breve.</p>

<h4 id="test-defectuoso-casos-de-test-insuficiente">Test defectuoso: casos de test insuficiente</h4>

<p>Vamos a evolucionar nuestra calculadora. El método add recibirá un nuevo parámetro de tipo <code class="highlighter-rouge">Mode</code> (de tipo enumerado), de forma que si su valor es <code class="highlighter-rouge">ABSOLUTE</code>, se realizará una suma de los valores absolutos de los operandos:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Calculator</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kt">long</span> <span class="n">add</span><span class="o">(</span><span class="kt">int</span> <span class="n">operand1</span><span class="o">,</span> <span class="kt">int</span> <span class="n">operand2</span><span class="o">,</span> <span class="n">Mode</span> <span class="n">mode</span><span class="o">)</span> <span class="o">{</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">ABSOLUTE</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">operand1</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">abs</span><span class="o">(</span><span class="n">operand1</span><span class="o">);</span>
            <span class="n">operand2</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">abs</span><span class="o">(</span><span class="n">operand2</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">operand1</span> <span class="o">+</span> <span class="n">operand2</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">enum</span> <span class="n">Mode</span> <span class="o">{</span><span class="n">ABSOLUTE</span><span class="o">,</span> <span class="n">STRAIGHT</span><span class="o">;}</span>
<span class="o">}</span></code></pre></figure>

<p>El test se mantiene, con la única modificación del parámetro:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testAdd</span><span class="p">(</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">operand1</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">operand2</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>

    <span class="kt">long</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">calculator</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">operand1</span><span class="o">,</span> <span class="n">operand2</span><span class="o">,</span> <span class="n">ABSOLUTE</span><span class="o">);</span>

    <span class="n">assertThat</span><span class="o">(</span><span class="n">sum</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">4</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<p>Este test es exitoso y da una cobertura del 100%, pero de nuevo, PIT nos desvela sus carencias:</p>

<p><img src="/public/pictures/pitest/pitest4.jpg" alt="Informe pitest" /></p>

<p>Lo que ha ocurrido aquí es que el test ha sobrevivido a la omisión de pasar los operandos a su valor absoluto. Esto es debido a que no hemos creado una suite de test cubriendo las diferentes combinaciones de datos que pueden dar lugar a escenarios diferentes (en este caso, números negativos). Vamos a solucionar esto utilizando tests parametrizados de JUnit (<a href="https://github.com/junit-team/junit/wiki/Parameterized-tests">más información aquí</a>):</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@RunWith</span><span class="o">(</span><span class="n">Parameterized</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CalculatorTest</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">Calculator</span> <span class="n">calculator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Calculator</span><span class="o">();</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">operand1</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">operand2</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">expectedResultStraight</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">expectedResultAbsolute</span><span class="o">;</span>

    <span class="nd">@Parameterized</span><span class="o">.</span><span class="na">Parameters</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Collection</span> <span class="n">data</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Object</span><span class="o">[][]</span> <span class="n">data</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[][]</span> <span class="o">{</span>
                <span class="o">{</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="mi">4</span> <span class="o">},</span>
                <span class="o">{</span> <span class="o">-</span><span class="mi">2</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">4</span> <span class="o">},</span>
                <span class="o">{</span> <span class="o">-</span><span class="mi">3</span><span class="o">,</span> <span class="o">-</span><span class="mi">3</span><span class="o">,</span> <span class="o">-</span><span class="mi">6</span><span class="o">,</span> <span class="mi">6</span> <span class="o">},</span>
                <span class="o">{</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span> <span class="o">}</span>
        <span class="o">};</span>

        <span class="k">return</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">CalculatorTest</span><span class="o">(</span><span class="kt">int</span> <span class="n">operand1</span><span class="o">,</span>
                          <span class="kt">int</span> <span class="n">operand2</span><span class="o">,</span>
                          <span class="kt">long</span> <span class="n">expectedResultStraight</span><span class="o">,</span>
                          <span class="kt">long</span> <span class="n">expectedResultAbsolute</span><span class="o">)</span> <span class="o">{</span>

        <span class="k">this</span><span class="o">.</span><span class="na">operand1</span> <span class="o">=</span> <span class="n">operand1</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">operand2</span> <span class="o">=</span> <span class="n">operand2</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">expectedResultStraight</span> <span class="o">=</span> <span class="n">expectedResultStraight</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">expectedResultAbsolute</span> <span class="o">=</span> <span class="n">expectedResultAbsolute</span><span class="o">;</span>
    <span class="o">}</span>


    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="n">testAddStraight</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">calculator</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">operand1</span><span class="o">,</span> <span class="n">operand2</span><span class="o">,</span> <span class="n">STRAIGHT</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">sum</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="n">expectedResultStraight</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="n">testAddAbsolute</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">calculator</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">operand1</span><span class="o">,</span> <span class="n">operand2</span><span class="o">,</span> <span class="n">ABSOLUTE</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">sum</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="n">expectedResultAbsolute</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span></code></pre></figure>

<p>En esta ocasión ponemos a prueba datos de diferente naturaleza y en ambos modos de ejecución. De nuevo, PIT vuelve a ser feliz, dando un 100% de mutaciones derribadas.</p>

<h4 id="test-defectuoso-verificacin-de-colaboraciones">Test defectuoso: verificación de colaboraciones</h4>

<p>Por último, añadamos a nuestra calculadora la funcionalidad de auditoría, de forma que todas las llamadas al método add sean registradas en algún sitio (que no importa demasiado a efectos de este post):</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Calculator</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">Audit</span> <span class="n">audit</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AuditImpl</span><span class="o">();</span>

    <span class="kd">public</span> <span class="kt">long</span> <span class="n">add</span><span class="o">(</span><span class="kt">int</span> <span class="n">operand1</span><span class="o">,</span> <span class="kt">int</span> <span class="n">operand2</span><span class="o">,</span> <span class="n">Mode</span> <span class="n">mode</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">audit</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"%d + %d (%s)"</span><span class="o">,</span> <span class="n">operand1</span><span class="o">,</span> <span class="n">operand2</span><span class="o">,</span> <span class="n">mode</span><span class="o">));</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">ABSOLUTE</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">operand1</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">abs</span><span class="o">(</span><span class="n">operand1</span><span class="o">);</span>
            <span class="n">operand2</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">abs</span><span class="o">(</span><span class="n">operand2</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">operand1</span> <span class="o">+</span> <span class="n">operand2</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">enum</span> <span class="n">Mode</span> <span class="o">{</span><span class="n">ABSOLUTE</span><span class="o">,</span> <span class="n">STRAIGHT</span><span class="o">;}</span>
<span class="o">}</span></code></pre></figure>

<p>La interfaz Audit y su implementación son bastante triviales, podéis verlas <a href="https://github.com/raulavila/blog-examples/tree/master/src/main/java/com/raulavila/mutationtesting">en el repositorio de GitHub</a>.</p>

<p>Si mantenemos la última versión de la suite de tests, la cobertura seguirá siendo del 100%, pero PIT encontrará un defecto:</p>

<p><img src="/public/pictures/pitest/pitest5.jpg" alt="Informe pitest" /></p>

<p>Lo que ha ocurrido aquí es que la interacción con Audit se ha eliminado, ¡¡¡y los tests no se han quejado de nada!!! Es evidente que nos hemos olvidado de <strong>verificar las interacciones con los colaboradores</strong>. Esto se puede conseguir fácilmente con un framework como <a href="http://mockito.org/">Mockito</a>, pero hay un problema, y es que el diseño de la clase <code class="highlighter-rouge">Calculator</code> no facilita la creación de mocks en tests unitarios. Supongo que ya habréis caído en la cuenta de que es necesario modificar nuestra clase para que pueda configurarse mediante <a href="/2015/03/principios-dependencias/">inyección de dependencias</a>:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Calculator</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">Audit</span> <span class="n">audit</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">Calculator</span><span class="o">(</span><span class="n">Audit</span> <span class="n">audit</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">audit</span> <span class="o">=</span> <span class="n">audit</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">//....</span>
<span class="o">}</span></code></pre></figure>

<p>Por último, esta sería la versión final de nuestra clase de test, verificando las colaboraciones mediante Mockito:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@RunWith</span><span class="o">(</span><span class="n">Parameterized</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CalculatorTest</span> <span class="o">{</span>

    <span class="nd">@Mock</span>
    <span class="kd">private</span> <span class="n">Audit</span> <span class="n">audit</span><span class="o">;</span>
    <span class="nd">@InjectMocks</span>
    <span class="kd">private</span> <span class="n">Calculator</span> <span class="n">calculator</span><span class="o">;</span>

    <span class="nd">@Before</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="n">setUp</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">MockitoAnnotations</span><span class="o">.</span><span class="na">initMocks</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">operand1</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">operand2</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">expectedResultStraight</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">expectedResultAbsolute</span><span class="o">;</span>

    <span class="nd">@Parameterized</span><span class="o">.</span><span class="na">Parameters</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Collection</span> <span class="n">data</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Object</span><span class="o">[][]</span> <span class="n">data</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[][]</span> <span class="o">{</span>
                <span class="o">{</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="mi">4</span> <span class="o">},</span>
                <span class="o">{</span> <span class="o">-</span><span class="mi">2</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">4</span> <span class="o">},</span>
                <span class="o">{</span> <span class="o">-</span><span class="mi">3</span><span class="o">,</span> <span class="o">-</span><span class="mi">3</span><span class="o">,</span> <span class="o">-</span><span class="mi">6</span><span class="o">,</span> <span class="mi">6</span> <span class="o">},</span>
                <span class="o">{</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span> <span class="o">}</span>
        <span class="o">};</span>

        <span class="k">return</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">CalculatorTest</span><span class="o">(</span><span class="kt">int</span> <span class="n">operand1</span><span class="o">,</span>
                          <span class="kt">int</span> <span class="n">operand2</span><span class="o">,</span>
                          <span class="kt">long</span> <span class="n">expectedResultStraight</span><span class="o">,</span>
                          <span class="kt">long</span> <span class="n">expectedResultAbsolute</span><span class="o">)</span> <span class="o">{</span>

        <span class="k">this</span><span class="o">.</span><span class="na">operand1</span> <span class="o">=</span> <span class="n">operand1</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">operand2</span> <span class="o">=</span> <span class="n">operand2</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">expectedResultStraight</span> <span class="o">=</span> <span class="n">expectedResultStraight</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">expectedResultAbsolute</span> <span class="o">=</span> <span class="n">expectedResultAbsolute</span><span class="o">;</span>
    <span class="o">}</span>


    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="n">testAddStraight</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">calculator</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">operand1</span><span class="o">,</span> <span class="n">operand2</span><span class="o">,</span> <span class="n">STRAIGHT</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">sum</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="n">expectedResultStraight</span><span class="o">);</span>

        <span class="n">verify</span><span class="o">(</span><span class="n">audit</span><span class="o">).</span><span class="na">register</span><span class="o">(</span>
                <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"%d + %d (STRAIGHT)"</span><span class="o">,</span> <span class="n">operand1</span><span class="o">,</span> <span class="n">operand2</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="n">testAddAbsolute</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">calculator</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">operand1</span><span class="o">,</span> <span class="n">operand2</span><span class="o">,</span> <span class="n">ABSOLUTE</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">sum</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="n">expectedResultAbsolute</span><span class="o">);</span>

        <span class="n">verify</span><span class="o">(</span><span class="n">audit</span><span class="o">).</span><span class="na">register</span><span class="o">(</span>
                <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"%d + %d (ABSOLUTE)"</span><span class="o">,</span> <span class="n">operand1</span><span class="o">,</span> <span class="n">operand2</span><span class="o">));</span>
    <span class="o">}</span>

<span class="o">}</span></code></pre></figure>

<p>Con lo que, de nuevo, hemos conseguido que PIT nos de un 100% de cobertura y de porcentaje de mutaciones derribadas :). Podría seguir explorando aún más las posibilidades de esta utilidad, pero creo que este ejemplo es más que suficiente para descubrir todo su potencial.</p>

<p>El único punto flaco que le encuentro es que, debido al proceso que es necesario ejecutar para mutar el código, en sistemas con gran número de tests y miles de líneas de código, el tiempo necesario para generar un informe completo es elevado. Pero algo así no debería ser problema si tenemos programados builds nocturnos en nuestros sistema de integración continua, ¿verdad?</p>

</article>

<aside class="related">
  <h2>Posts relacionados</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2016/11/codemotion-2016">
            Codemotion 2016
            <small><time datetime="2016-11-21T00:00:00+00:00">21/11/2016</time></small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2016/11/perdon-por-la-ausencia/">
            Perdón por la ausencia
            <small><time datetime="2016-11-12T00:00:00+00:00">12/11/2016</time></small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2016/09/extract-till-you-drop/">
            Extract till you drop
            <small><time datetime="2016-09-25T00:00:00+01:00">25/09/2016</time></small>
          </a>
        </h3>
      </li>
    
  </ul>
</aside>

        
<div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'raulavila'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

      </main>

      <footer class="footer">
        <small>
          &copy; <time datetime="2016">2016</time> Raúl Ávila. Blog creado con <a href="http://jekyllrb.com">Jekyll</a>.
          Plantilla basada en <a href="http://getpoole.com">Poole</a>.
          <a href="/atom.xml">Atom Feed</a></a>.
          <br>
        </small>
      </footer>
    </div>

  <script>
window.twttr=(function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],t=window.twttr||{};if(d.getElementById(id))return;js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);t._e=[];t.ready=function(f){t._e.push(f);};return t;}(document,"script","twitter-wjs"));
</script>

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-58942569-1', 'auto');
  ga('send', 'pageview');

</script>

  </body>
</html>

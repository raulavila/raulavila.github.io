<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <link href="http://gmpg.org/xfn/11" rel="profile">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Eliminando dependencias estáticas en legacy code
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/atom+xml" title="Raúl Ávila" href="/atom.xml">

</head>


  <body>

    <div class="container content">
      <header class="masthead">
        <h1 class="masthead-title">
          <a href="/" title="Home">Raúl Ávila</a>
        </h1>

            <small><a href="/sobre-mi">Sobre mí</a></small>
            &nbsp;&nbsp;&nbsp;
            <small><a href="/archivos">Archivos</a></small>
      </header>

      <main>
        <article class="post">
  <h1 class="post-title">Eliminando dependencias estáticas en legacy code</h1>
  <time datetime="2015-03-15T00:00:00+01:00" class="post-date">15/03/2015</time>
  <div class="post-tags">
    
    | <a href="/tag/desarrollo">desarrollo</a> |
    
    | <a href="/tag/refactoring">refactoring</a> |
    
    | <a href="/tag/legacy">legacy</a> |
    
  </div>  
  <div class="post-share">
    <a class="twitter-share-button" 
    data-via="ravila80"
    data-count="none"
    href="https://twitter.com/share">Tweet</a>
  </div>  
  <p>Modificar un sistema legacy es, quizás, una de las labores más desagradables de nuestra profesión, sobre todo cuando nos es completamente ajeno. El motivo es, sin discusión, <strong>la ausencia de tests</strong>.</p>

<p>En efecto, hasta hace unos años, la norma de la industria venía a ser, “desarrollar lo más rápido posible para salir a producción”. Dentro de esa filosofía, la implementación de tests (unitarios, de integración, de sistema, etc) parecía entenderse como una pérdida de tiempo total. El concepto de <a href="http://es.wikipedia.org/wiki/Deuda_t%C3%A9cnica">deuda técnica</a> era desconocido (o parecía serlo), y nadie pensaba en las consecuencias posteriores, tan sólo en el “sálvese quién pueda”.</p>

<!--break-->

<p>No me voy a extender aquí en los peligros de semejante barbaridad. Los sistemas van creciendo sin control, el <a href="http://stackoverflow.com/questions/2756527/what-is-spaghetti-code">Spaghetti code</a> hace acto de presencia, los diferentes módulos del sistema están cada vez más acoplados, y cualquier mínimo cambio tiene consecuencias desastrosas en partes del sistema que no podríamos ni imaginar.</p>

<p>Precisamente el no desarrollar tests unitarios es una de las principales causas de llegar a ese resultado. Los tests, si son realmente unitarios, nos ayudan a aislar dependencias entre clases/módulos, de forma que nos llevan a mejorar dramáticamente la calidad de nuestro diseño.</p>

<p>Uno de los grandes vicios de sistemas antiguos es el uso excesivo de métodos estáticos, así como de clases estáticas (clase con todos sus miembros estáticos). El problema es que un método estático no deja de ser un método global, y todos aprendimos que las variables globales son malas cuando aprendimos a programar, ¿verdad? :)</p>

<p>El mayor inconveniente de los métodos estáticos es lo enormemente que dificultan el desarrollo de tests unitarios de las clases que los utilizan, porque es bastante complicado crear <a href="http://java-white-box.blogspot.co.uk/2012/12/java-player-que-es-un-mock-para-que.html">Mocks</a> de estos métodos. Existen librerías como <a href="https://code.google.com/p/powermock/">PowerMock</a> para puentear esta restricción, pero a mi parecer ensucian bastante los tests, y además los hacen mucho más difíciles de depurar.</p>

<p>Si descartamos el uso de PowerMock, la opción es no crear un Mock de la clase estática, pero en tal caso ya no tendríamos tests unitarios, o intentar eliminar la naturaleza estática a los métodos/clases que nos están molestando.</p>

<p>Esta labor no es sencilla, cuando hay que abarcarla en un proyecto con miles de líneas de código, que además no contiene ningún test. Describiré a continuación una técnica paso a paso para conseguirlo de la forma más segura posible, técnica que aprendí en uno de los hangouts del <a href="http://virtualjug.com/">VirtualJUG</a> impartido por <a href="https://twitter.com/sandromancuso">Sandro Mancuso</a>.</p>

<h3 id="el-sistema-de-partida">El sistema de partida</h3>

<p>Nuestro caso de uso es un sistema de registro y cobro de multas. El modelo de datos está simplificado al máximo, y contiene solo dos clases:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Person</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>

    <span class="c1">//...contructor, getters, setters</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Fine</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Person</span> <span class="n">person</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">BigDecimal</span> <span class="n">amount</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">paid</span><span class="o">;</span>

    <span class="c1">//...</span>
<span class="o">}</span></code></pre></div>

<p>El importe de la multa es de tipo BigDecimal, que es el tipo recomendado en Java para almacenar cantidades monetarias.</p>

<p>Las clase DAO de Person está simplificada como un contenedor de constantes:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PersonDAO</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Person</span> <span class="n">JOHN</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Person</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="s">&quot;John&quot;</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Person</span> <span class="n">RAUL</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Person</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="s">&quot;Raul&quot;</span><span class="o">);</span>
<span class="o">}</span></code></pre></div>

<p>La clase DAO de Fine sería como sigue:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FineDAO</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Fine</span><span class="o">&gt;</span> <span class="n">fines</span> <span class="o">=</span> <span class="n">Lists</span><span class="o">.</span><span class="na">newArrayList</span><span class="o">();</span>

    <span class="kd">static</span> <span class="o">{</span>
        <span class="n">fines</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nf">Fine</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">JOHN</span><span class="o">,</span> <span class="n">valueOf</span><span class="o">(</span><span class="mi">100</span><span class="o">),</span> <span class="kc">true</span><span class="o">));</span>
        <span class="n">fines</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nf">Fine</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="n">JOHN</span><span class="o">,</span> <span class="n">valueOf</span><span class="o">(</span><span class="mi">110</span><span class="o">),</span> <span class="kc">true</span><span class="o">));</span>
        <span class="n">fines</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nf">Fine</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="n">RAUL</span><span class="o">,</span> <span class="n">valueOf</span><span class="o">(</span><span class="mi">120</span><span class="o">),</span> <span class="kc">true</span><span class="o">));</span>
        <span class="n">fines</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nf">Fine</span><span class="o">(</span><span class="mi">4</span><span class="o">,</span> <span class="n">RAUL</span><span class="o">,</span> <span class="n">valueOf</span><span class="o">(</span><span class="mi">130</span><span class="o">),</span> <span class="kc">false</span><span class="o">));</span>
        <span class="n">fines</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nf">Fine</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="n">RAUL</span><span class="o">,</span> <span class="n">valueOf</span><span class="o">(</span><span class="mi">140</span><span class="o">),</span> <span class="kc">false</span><span class="o">));</span>
    <span class="o">}</span>


    <span class="kd">public</span> <span class="kd">static</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Fine</span><span class="o">&gt;</span> <span class="nf">getFines</span><span class="o">(</span><span class="n">Person</span> <span class="n">person</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Fine</span><span class="o">&gt;</span> <span class="n">output</span> <span class="o">=</span> <span class="n">Lists</span><span class="o">.</span><span class="na">newArrayList</span><span class="o">();</span>

        <span class="k">for</span> <span class="o">(</span><span class="n">Fine</span> <span class="n">fine</span> <span class="o">:</span> <span class="n">fines</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">fine</span><span class="o">.</span><span class="na">getPerson</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">person</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">output</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">fine</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">output</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div>

<p>Como se puede ver, almacena una lista de multas en memoria, lo que vendría a ser una representación in memory de una tabla Fine. Suficiente para nuestro ejemplo, aunque nada correcto, por supuesto. Solo contiene un método de acceso a datos, getFines, que recibe una instancia de Person y devuelve una lista de todas las multas registradas a nombre de esa persona.</p>

<p>Tenemos por último una clase FineService, con lógica asociada a la gestión de multas:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FineService</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Fine</span><span class="o">&gt;</span> <span class="nf">getUnpaidFines</span><span class="o">(</span><span class="n">Person</span> <span class="n">person</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Fine</span><span class="o">&gt;</span> <span class="n">output</span> <span class="o">=</span> <span class="n">Lists</span><span class="o">.</span><span class="na">newArrayList</span><span class="o">();</span>

        <span class="n">List</span><span class="o">&lt;</span><span class="n">Fine</span><span class="o">&gt;</span> <span class="n">fines</span> <span class="o">=</span> <span class="n">FineDAO</span><span class="o">.</span><span class="na">getFines</span><span class="o">(</span><span class="n">person</span><span class="o">);</span>

        <span class="k">for</span> <span class="o">(</span><span class="n">Fine</span> <span class="n">fine</span> <span class="o">:</span> <span class="n">fines</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">fine</span><span class="o">.</span><span class="na">isPaid</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">output</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">fine</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">output</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div>

<p>Solo contiene un método, <code>getUnpaidFines</code>, que devuelve una lista de las multas impagadas por la persona proporcionada en los parámetros.</p>

<p>Esto es todo. Un sistema bastante tonto, pero con una carencia muy importante (dejando aparte simplificaciones de las clases DAO para este post): la clase <code>FineDAO</code> ha sido creada como una clase estática, por lo que está fuertemente acoplada con la clase que la utiliza, <code>FineService</code>.</p>

<p>Imaginemos que el sistema es monstruoso y existen dependencias de la clase DAO por todas partes. ¿Cómo eliminar la naturaleza estática de forma segura? Veámoslo.</p>

<h3 id="el-proceso-paso-a-paso">El proceso, paso a paso</h3>

<p>Lo primero que tenemos que hacer es crear tests para la clase <code>FineService</code>:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FineServiceTest</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">Person</span> <span class="n">JOHN</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Person</span> <span class="n">RAUL</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">FineService</span> <span class="n">fineService</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">FineService</span><span class="o">();</span>

    <span class="nd">@Before</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUp</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">JOHN</span> <span class="o">=</span> <span class="n">PersonDAO</span><span class="o">.</span><span class="na">JOHN</span><span class="o">;</span>
        <span class="n">RAUL</span> <span class="o">=</span> <span class="n">PersonDAO</span><span class="o">.</span><span class="na">RAUL</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testGetUnpaidFines</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Fine</span><span class="o">&gt;</span> <span class="n">unpaidFines</span> <span class="o">=</span> <span class="n">fineService</span><span class="o">.</span><span class="na">getUnpaidFines</span><span class="o">(</span><span class="n">RAUL</span><span class="o">);</span>
        <span class="n">Assertions</span><span class="o">.</span><span class="na">assertThat</span><span class="o">(</span><span class="n">unpaidFines</span><span class="o">).</span><span class="na">hasSize</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testNoUnpaidFines</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Fine</span><span class="o">&gt;</span> <span class="n">unpaidFines</span> <span class="o">=</span> <span class="n">fineService</span><span class="o">.</span><span class="na">getUnpaidFines</span><span class="o">(</span><span class="n">JOHN</span><span class="o">);</span>
        <span class="n">Assertions</span><span class="o">.</span><span class="na">assertThat</span><span class="o">(</span><span class="n">unpaidFines</span><span class="o">).</span><span class="na">isEmpty</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div>

<p>Varias puntualizaciones aquí:</p>

<ul>
  <li>Teniendo en cuenta que la clase <code>PersonDAO</code> es una chapucilla creada para el ejemplo, en un sistema legacy real lo más seguro es que también fuera una clase estática, con sus métodos <code>getPersonByXXX</code>, que también habría que eliminar</li>
  <li>La clase service no tiene control de errores, etc, y los tests deberían ser más completos, comprobando no solo el número de multas devueltas. De nuevo, he optado por la simplicidad para centrarme en un aspecto muy determinado</li>
</ul>

<h4 id="el-problema-la-clase-dao-accede-a-la-capa-de-persistencia">El problema: la clase DAO accede a la capa de persistencia</h4>

<p>Efectivamente, ¿qué clase de test unitario accede a los datos reales? Como la clase <code>FineDAO</code> es estática, tenemos que pensar en alguna forma de “mockear” la llamada al método <code>getFines</code>…Para ello lo primero que vamos a hacer es aislar la invocación a <code>FineDAO.getFines</code> en un método propio dentro de <code>FineService</code>:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FineService</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Fine</span><span class="o">&gt;</span> <span class="nf">getUnpaidFines</span><span class="o">(</span><span class="n">Person</span> <span class="n">person</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Fine</span><span class="o">&gt;</span> <span class="n">output</span> <span class="o">=</span> <span class="n">Lists</span><span class="o">.</span><span class="na">newArrayList</span><span class="o">();</span>

        <span class="n">List</span><span class="o">&lt;</span><span class="n">Fine</span><span class="o">&gt;</span> <span class="n">fines</span> <span class="o">=</span> <span class="n">getFines</span><span class="o">(</span><span class="n">person</span><span class="o">);</span>

        <span class="k">for</span> <span class="o">(</span><span class="n">Fine</span> <span class="n">fine</span> <span class="o">:</span> <span class="n">fines</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">fine</span><span class="o">.</span><span class="na">isPaid</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">output</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">fine</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">output</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">protected</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Fine</span><span class="o">&gt;</span> <span class="nf">getFines</span><span class="o">(</span><span class="n">Person</span> <span class="n">person</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">FineDAO</span><span class="o">.</span><span class="na">getFines</span><span class="o">(</span><span class="n">person</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div>

<p>¿Por qué protected? Porque la idea al hacer esto es crear una clase derivada que sobrescriba ese método:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FineServiceTestable</span> <span class="kd">extends</span> <span class="n">FineService</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Fine</span><span class="o">&gt;</span> <span class="nf">getFines</span><span class="o">(</span><span class="n">Person</span> <span class="n">person</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">getFines</span><span class="o">(</span><span class="n">person</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div>

<p>Por supuesto, en el test ahora deberemos instanciar esta nueva clase:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="n">FineService</span> <span class="n">fineService</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">FineServiceTestable</span><span class="o">();</span></code></pre></div>

<p>Paro un momento para hacer hincapié en que, la idea de este proceso es implementarlo en incrementos pequeños, <strong>ejecutando los tests a cada paso</strong>. El uso de una herramienta como <a href="https://infinitest.github.io/">infinitest</a> facilita bastante esta labor, porque lo hace automáticamente.</p>

<h4 id="aislando-dependencias-en-los-tests">Aislando dependencias en los tests</h4>

<p>Ya estamos en posición de eliminar la dependencia de la clase estática en el test de <code>FineService</code>. Esto se hace modificando el método <code>getFines</code> de FineServiceTestable:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FineServiceTestable</span> <span class="kd">extends</span> <span class="n">FineService</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Fine</span><span class="o">&gt;</span> <span class="n">fines</span> <span class="o">=</span> <span class="n">Lists</span><span class="o">.</span><span class="na">newArrayList</span><span class="o">();</span>

    <span class="kd">public</span> <span class="nf">FineServiceTestable</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">fines</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nf">Fine</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">JOHN</span><span class="o">,</span> <span class="n">valueOf</span><span class="o">(</span><span class="mi">100</span><span class="o">),</span> <span class="kc">true</span><span class="o">));</span>
        <span class="n">fines</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nf">Fine</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="n">JOHN</span><span class="o">,</span> <span class="n">valueOf</span><span class="o">(</span><span class="mi">110</span><span class="o">),</span> <span class="kc">true</span><span class="o">));</span>
        <span class="n">fines</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nf">Fine</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="n">RAUL</span><span class="o">,</span> <span class="n">valueOf</span><span class="o">(</span><span class="mi">120</span><span class="o">),</span> <span class="kc">true</span><span class="o">));</span>
        <span class="n">fines</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nf">Fine</span><span class="o">(</span><span class="mi">4</span><span class="o">,</span> <span class="n">RAUL</span><span class="o">,</span> <span class="n">valueOf</span><span class="o">(</span><span class="mi">130</span><span class="o">),</span> <span class="kc">false</span><span class="o">));</span>
        <span class="n">fines</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nf">Fine</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="n">RAUL</span><span class="o">,</span> <span class="n">valueOf</span><span class="o">(</span><span class="mi">140</span><span class="o">),</span> <span class="kc">false</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Fine</span><span class="o">&gt;</span> <span class="nf">getFines</span><span class="o">(</span><span class="n">Person</span> <span class="n">person</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Fine</span><span class="o">&gt;</span> <span class="n">output</span> <span class="o">=</span> <span class="n">Lists</span><span class="o">.</span><span class="na">newArrayList</span><span class="o">();</span>

        <span class="k">for</span> <span class="o">(</span><span class="n">Fine</span> <span class="n">fine</span> <span class="o">:</span> <span class="n">fines</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">fine</span><span class="o">.</span><span class="na">getPerson</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">person</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">output</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">fine</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">output</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div>

<p>¡Maldita sea!, diréis. ¡Esta clase hace exactamente lo mismo que FineDAO! Bien, recordemos que FineDAO es un ejemplo muy simplificado, que en la realidad accedería a base de datos a traves de JDBC, MyBatis, Hibernate…En tal caso la clase <code>FineServiceTestable</code> sí pasaría a ser totalmente diferente. Además…nos hemos librado de la dependencia estática, que es lo que queríamos, ¿verdad?</p>

<h4 id="refactorizando-finedao">Refactorizando FineDAO</h4>

<p>Vamos a eliminar paso a paso la naturaleza estática de FineDAO. Creemos en primer lugar los tests de la clase:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FineDAOTest</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">Person</span> <span class="n">JOHN</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Person</span> <span class="n">RAUL</span><span class="o">;</span>

    <span class="nd">@Before</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUp</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">JOHN</span> <span class="o">=</span> <span class="n">PersonDAO</span><span class="o">.</span><span class="na">JOHN</span><span class="o">;</span>
        <span class="n">RAUL</span> <span class="o">=</span> <span class="n">PersonDAO</span><span class="o">.</span><span class="na">RAUL</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testGetFines</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Fine</span><span class="o">&gt;</span> <span class="n">finesJohn</span> <span class="o">=</span> <span class="n">FineDAO</span><span class="o">.</span><span class="na">getFines</span><span class="o">(</span><span class="n">JOHN</span><span class="o">);</span>
        <span class="n">Assertions</span><span class="o">.</span><span class="na">assertThat</span><span class="o">(</span><span class="n">finesJohn</span><span class="o">).</span><span class="na">hasSize</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>

        <span class="n">List</span><span class="o">&lt;</span><span class="n">Fine</span><span class="o">&gt;</span> <span class="n">finesRaul</span> <span class="o">=</span> <span class="n">FineDAO</span><span class="o">.</span><span class="na">getFines</span><span class="o">(</span><span class="n">RAUL</span><span class="o">);</span>
        <span class="n">Assertions</span><span class="o">.</span><span class="na">assertThat</span><span class="o">(</span><span class="n">finesRaul</span><span class="o">).</span><span class="na">hasSize</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div>

<p>Añadamos ahora un método de instancia a la clase FineDAO que delega su comportamiento en el método estático:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FineDAO</span> <span class="o">{</span>
 <span class="c1">//...</span>
 <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Fine</span><span class="o">&gt;</span> <span class="nf">getFinesByPerson</span><span class="o">(</span><span class="n">Person</span> <span class="n">person</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">FineDAO</span><span class="o">.</span><span class="na">getFines</span><span class="o">(</span><span class="n">person</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div>

<p>Y añadamos un test para este método:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FineDAOTest</span> <span class="o">{</span>
    <span class="c1">//...</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testGetFinesByPerson</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">FineDAO</span> <span class="n">fineDAO</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">FineDAO</span><span class="o">();</span>

        <span class="n">List</span><span class="o">&lt;</span><span class="n">Fine</span><span class="o">&gt;</span> <span class="n">finesJohn</span> <span class="o">=</span> <span class="n">fineDAO</span><span class="o">.</span><span class="na">getFinesByPerson</span><span class="o">(</span><span class="n">JOHN</span><span class="o">);</span>
        <span class="n">Assertions</span><span class="o">.</span><span class="na">assertThat</span><span class="o">(</span><span class="n">finesJohn</span><span class="o">).</span><span class="na">hasSize</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>

        <span class="n">List</span><span class="o">&lt;</span><span class="n">Fine</span><span class="o">&gt;</span> <span class="n">finesRaul</span> <span class="o">=</span> <span class="n">fineDAO</span><span class="o">.</span><span class="na">getFinesByPerson</span><span class="o">(</span><span class="n">RAUL</span><span class="o">);</span>
        <span class="n">Assertions</span><span class="o">.</span><span class="na">assertThat</span><span class="o">(</span><span class="n">finesRaul</span><span class="o">).</span><span class="na">hasSize</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div>

<p>De nuevo, vamos paso a paso, con todos nuestros tests en verde, y sin romper otras partes del sistema.</p>

<p>Lo siguiente sería inyectar la dependencia <code>FineDAO</code> en <code>FineService</code>, y eliminar la dependencia estática:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FineService</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">FineDAO</span> <span class="n">fineDAO</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Fine</span><span class="o">&gt;</span> <span class="nf">getUnpaidFines</span><span class="o">(</span><span class="n">Person</span> <span class="n">person</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Fine</span><span class="o">&gt;</span> <span class="n">output</span> <span class="o">=</span> <span class="n">Lists</span><span class="o">.</span><span class="na">newArrayList</span><span class="o">();</span>

        <span class="n">List</span><span class="o">&lt;</span><span class="n">Fine</span><span class="o">&gt;</span> <span class="n">fines</span> <span class="o">=</span> <span class="n">getFines</span><span class="o">(</span><span class="n">person</span><span class="o">);</span>

        <span class="k">for</span> <span class="o">(</span><span class="n">Fine</span> <span class="n">fine</span> <span class="o">:</span> <span class="n">fines</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">fine</span><span class="o">.</span><span class="na">isPaid</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">output</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">fine</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">output</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">protected</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Fine</span><span class="o">&gt;</span> <span class="nf">getFines</span><span class="o">(</span><span class="n">Person</span> <span class="n">person</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">fineDAO</span><span class="o">.</span><span class="na">getFinesByPerson</span><span class="o">(</span><span class="n">person</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setFineDAO</span><span class="o">(</span><span class="n">FineDAO</span> <span class="n">fineDAO</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">fineDAO</span> <span class="o">=</span> <span class="n">fineDAO</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div>

<p>La inyección de dependencias puede realizarse de múltiple formas (setters, constructores, anotaciones…). Intentando simplificar, en el ejemplo se hará mediente un setter.</p>

<h4 id="aadiendo-mocks-autnticos">Añadiendo Mocks auténticos</h4>

<p>Puesto que ya no tenemos dependencias estáticas en la clase <code>FineService</code>, es posible “mockear” sus dependencias de la forma tradicional, utilizando un framework como <a href="https://code.google.com/p/mockito/">Mockito</a>. Dejamos de utilizar, por tanto, la clase <code>FineServiceTestable</code>:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FineServiceTest</span> <span class="o">{</span>
<span class="c1">//...</span>
    <span class="nd">@Mock</span>
    <span class="kd">private</span> <span class="n">FineDAO</span> <span class="n">fineDAO</span><span class="o">;</span>
    <span class="nd">@InjectMocks</span>
    <span class="kd">private</span> <span class="n">FineService</span> <span class="n">fineService</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">FineService</span><span class="o">();</span>

    <span class="nd">@Before</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUp</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">MockitoAnnotations</span><span class="o">.</span><span class="na">initMocks</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
<span class="c1">//...</span>
<span class="o">}</span></code></pre></div>

<p>En este fragmento reflejo solo los cambios sobre la versión anterior. Hemos añadido Mockito al proyecto, inicializando los mocks en el método <code>setUp</code>, configurando la clase DAO para que se cree como mock, y la clase <code>FineService</code> para que se inyecten todas las dependencias.</p>

<p>En esta ocasión los tests no pasan, porque fineDAO es un mock al que aún no hemos asociado ningún comportamiento. Solventemos esto en cada uno de los tests:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testGetUnpaidFines</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="n">when</span><span class="o">(</span><span class="n">fineDAO</span><span class="o">.</span><span class="na">getFinesByPerson</span><span class="o">(</span><span class="n">RAUL</span><span class="o">)).</span><span class="na">thenReturn</span><span class="o">(</span>
            <span class="n">Lists</span><span class="o">.</span><span class="na">newArrayList</span><span class="o">(</span>
                    <span class="k">new</span> <span class="nf">Fine</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="n">RAUL</span><span class="o">,</span> <span class="n">valueOf</span><span class="o">(</span><span class="mi">120</span><span class="o">),</span> <span class="kc">true</span><span class="o">),</span>
                    <span class="k">new</span> <span class="nf">Fine</span><span class="o">(</span><span class="mi">4</span><span class="o">,</span> <span class="n">RAUL</span><span class="o">,</span> <span class="n">valueOf</span><span class="o">(</span><span class="mi">130</span><span class="o">),</span> <span class="kc">false</span><span class="o">),</span>
                    <span class="k">new</span> <span class="nf">Fine</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="n">RAUL</span><span class="o">,</span> <span class="n">valueOf</span><span class="o">(</span><span class="mi">140</span><span class="o">),</span> <span class="kc">false</span><span class="o">)));</span>

    <span class="n">List</span><span class="o">&lt;</span><span class="n">Fine</span><span class="o">&gt;</span> <span class="n">unpaidFines</span> <span class="o">=</span> <span class="n">fineService</span><span class="o">.</span><span class="na">getUnpaidFines</span><span class="o">(</span><span class="n">RAUL</span><span class="o">);</span>
    <span class="n">Assertions</span><span class="o">.</span><span class="na">assertThat</span><span class="o">(</span><span class="n">unpaidFines</span><span class="o">).</span><span class="na">hasSize</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
<span class="o">}</span>

<span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testNoUnpaidFines</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="n">when</span><span class="o">(</span><span class="n">fineDAO</span><span class="o">.</span><span class="na">getFinesByPerson</span><span class="o">(</span><span class="n">JOHN</span><span class="o">)).</span><span class="na">thenReturn</span><span class="o">(</span>
            <span class="n">Lists</span><span class="o">.</span><span class="na">newArrayList</span><span class="o">(</span>
                    <span class="k">new</span> <span class="nf">Fine</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">RAUL</span><span class="o">,</span> <span class="n">valueOf</span><span class="o">(</span><span class="mi">100</span><span class="o">),</span> <span class="kc">true</span><span class="o">),</span>
                    <span class="k">new</span> <span class="nf">Fine</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="n">RAUL</span><span class="o">,</span> <span class="n">valueOf</span><span class="o">(</span><span class="mi">110</span><span class="o">),</span> <span class="kc">true</span><span class="o">)));</span>

    <span class="n">List</span><span class="o">&lt;</span><span class="n">Fine</span><span class="o">&gt;</span> <span class="n">unpaidFines</span> <span class="o">=</span> <span class="n">fineService</span><span class="o">.</span><span class="na">getUnpaidFines</span><span class="o">(</span><span class="n">JOHN</span><span class="o">);</span>
    <span class="n">Assertions</span><span class="o">.</span><span class="na">assertThat</span><span class="o">(</span><span class="n">unpaidFines</span><span class="o">).</span><span class="na">isEmpty</span><span class="o">();</span>
<span class="o">}</span></code></pre></div>

<p>Ya tenemos todos los tests en verde, y hemos conseguido lo que buscábamos, librarnos de la dependencia estática :D</p>

<h4 id="repetir-el-proceso-para-dependencias-pendientes">Repetir el proceso para dependencias pendientes</h4>

<p>Si existen más dependencias en el sistema del método estático <code>FineDAO.getFines</code>, deberíamos repetir el proceso  para cada una de ellas. En caso contrario, habrá llegado el momento de eliminar definitivamente el método (moviendo su cuerpo dentro del método de instancia, eliminando de esta forma la delegación), y si queremos, renombrar el método instancia a getFines (el IDE se encargará de actualizar todas sus referencias sin problema). También tendremos que eliminar los tests del método estático, puesto que dejarán de compilar. La cosa, por tanto, queda así:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FineDAO</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Fine</span><span class="o">&gt;</span> <span class="n">fines</span> <span class="o">=</span> <span class="n">Lists</span><span class="o">.</span><span class="na">newArrayList</span><span class="o">();</span>

    <span class="kd">static</span> <span class="o">{</span>
        <span class="n">fines</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nf">Fine</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">JOHN</span><span class="o">,</span> <span class="n">valueOf</span><span class="o">(</span><span class="mi">100</span><span class="o">),</span> <span class="kc">true</span><span class="o">));</span>
        <span class="n">fines</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nf">Fine</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="n">JOHN</span><span class="o">,</span> <span class="n">valueOf</span><span class="o">(</span><span class="mi">110</span><span class="o">),</span> <span class="kc">true</span><span class="o">));</span>
        <span class="n">fines</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nf">Fine</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="n">RAUL</span><span class="o">,</span> <span class="n">valueOf</span><span class="o">(</span><span class="mi">120</span><span class="o">),</span> <span class="kc">true</span><span class="o">));</span>
        <span class="n">fines</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nf">Fine</span><span class="o">(</span><span class="mi">4</span><span class="o">,</span> <span class="n">RAUL</span><span class="o">,</span> <span class="n">valueOf</span><span class="o">(</span><span class="mi">130</span><span class="o">),</span> <span class="kc">false</span><span class="o">));</span>
        <span class="n">fines</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nf">Fine</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="n">RAUL</span><span class="o">,</span> <span class="n">valueOf</span><span class="o">(</span><span class="mi">140</span><span class="o">),</span> <span class="kc">false</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Fine</span><span class="o">&gt;</span> <span class="nf">getFines</span><span class="o">(</span><span class="n">Person</span> <span class="n">person</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Fine</span><span class="o">&gt;</span> <span class="n">output</span> <span class="o">=</span> <span class="n">Lists</span><span class="o">.</span><span class="na">newArrayList</span><span class="o">();</span>

        <span class="k">for</span> <span class="o">(</span><span class="n">Fine</span> <span class="n">fine</span> <span class="o">:</span> <span class="n">fines</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">fine</span><span class="o">.</span><span class="na">getPerson</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">person</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">output</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">fine</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">output</span><span class="o">;</span>

    <span class="o">}</span>
<span class="o">}</span></code></pre></div>

<h2 id="conclusiones">Conclusiones</h2>

<p>Eliminar esta dependencia estática no significa que ya esté todo el trabajo hecho. En el ejemplo utilizado en este post habría que seguir eliminando más dependencias estáticas (<code>PersonDAO</code>), y en un sistema legacy real seguramente estemos solo comenzando.</p>

<p>Sin embargo hemos conseguido varias mejoras, entre otras:</p>

<ul>
  <li>Desacoplar dependencias</li>
  <li>Disminuir la rigidez del sistema</li>
  <li>Mejorar la cobertura de tests</li>
</ul>

<p>(El código como siempre, en <a href="https://github.com/raulavila/refactoring-examples">GitHub</a>).</p>

</article>

<aside class="related">
  <h2>Posts relacionados</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2015/04/trabajo-londres">
            Cómo encontré trabajo de informático en Londres
            <small><time datetime="2015-04-05T00:00:00+02:00">05/04/2015</time></small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2015/04/reuniones">
            Las reuniones en proyectos de desarrollo
            <small><time datetime="2015-04-02T00:00:00+02:00">02/04/2015</time></small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2015/03/code-reviews">
            Code Reviews (revisiones de código)
            <small><time datetime="2015-03-26T00:00:00+01:00">26/03/2015</time></small>
          </a>
        </h3>
      </li>
    
  </ul>
</aside>

        
<div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'raulavila'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

      </main>

      <footer class="footer">
        <small>
          &copy; <time datetime="2015">2015</time> Raúl Ávila. Blog creado con <a href="http://jekyllrb.com">Jekyll</a>.
          Plantilla basada en <a href="http://getpoole.com">Poole</a>.
          <a href="/atom.xml">Atom Feed</a></a>.
          <br>
        </small>
      </footer>
    </div>

  <script>
window.twttr=(function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],t=window.twttr||{};if(d.getElementById(id))return;js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);t._e=[];t.ready=function(f){t._e.push(f);};return t;}(document,"script","twitter-wjs"));
</script>

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-58942569-1', 'auto');
  ga('send', 'pageview');

</script>

  </body>
</html>
